#include "json_config_comm_func_private.h"
#include "json_config_type_private.h"
#include "json_config_type_file_private.h"
#include "json_config_type_file_sequence_private.h"
#include "json_config_var_module_hash_private.h"

#define JC_TYPE_FILE_MODULE_EXTRA 10

struct jc_type_file_seq {
	jc_var_module_t  jvm;
};

struct jc_type_file_seq_oper {
	int (*seq_init)(struct json_config_comm *jcc);
	int (*seq_copy)(unsigned int data_num);
	int (*seq_execute)(struct json_config_comm *jcc);
};

static struct jc_type_file_seq  global_seq;

static int
jc_type_file_seq_oper_destroy(
	unsigned long user_data
)
{
	if (user_data)
		free((void*)user_data);

	return JC_OK;
}

int
jc_type_file_seq_module_add(
	char *module,
	struct jc_type_file_seq_oper *oper		
)
{
	struct jc_type_file_seq_oper *oper_new = NULL;

	oper_new = (typeof(oper_new))calloc(1, sizeof(*oper));
	if (oper)
		memcpy(oper_new, oper, sizeof(*oper));

	return jc_module_add(module, (unsigned long)oper_new, global_seq.jvm);
}

static int
jc_type_file_seq_init(
	struct json_config_comm *jcc
)
{
	int ret = 0;
	int len = 0;
	char *module = NULL;
	struct jc_type_private *jtp = NULL;
	struct jc_var_module_param param;
	struct jc_type_file_private *jtfp = NULL;
	struct jc_type_file_seq_oper *oper = NULL;
	
	jtp = (typeof(jtp))jcc->module_private;
	jtfp = (typeof(jtfp))jtp->sub_module_private;
	len = strlen(jtfp->comm->end_action) + strlen(jtfp->comm->module) + 
		JC_TYPE_FILE_MODULE_EXTRA;
	module = (char*)calloc(1, len + 1);
	if (!module) {
		fprintf(stderr, "calloc %d bytes error : %s\n",
				len + 1, strerror(errno));
		exit(0);
	}
	sprintf(module, "%s_%s", jtfp->comm->end_action, jtfp->comm->module);
	memset(&param, 0, sizeof(param));
	param.un.module = module;
	oper = (typeof(oper))jc_module_get(&param, &global_seq.jvm);
	if (!oper) 
		return JC_ERR;

	if (oper->seq_init)
		ret = oper->seq_init(jcc);

	return jc_var_add(jcc->depth, jtp->node_name, module, global_seq.jvm);
}

static int
jc_type_file_seq_copy_walk(
	unsigned long m_data,
	unsigned long user_data
)
{
	int data_num = 0;
	struct jc_type_file_seq_oper *oper = NULL;

	oper = (typeof(oper))m_data;
	data_num = (unsigned int)user_data;

	if (oper->seq_copy)
		return oper->seq_copy(data_num);
	return JC_OK;
}

static int
jc_type_file_seq_copy(
	unsigned int data_num
)
{
	return jc_var_module_traversal(global_seq.jvm, data_num, 
			               jc_type_file_seq_copy_walk);
}

static int
jc_type_file_seq_execute(
	struct json_config_comm *jcc
)
{
	struct jc_type_private *jtp = NULL;
	struct jc_type_file_seq_oper *oper = NULL;
	struct jc_var_module_param param;

	jtp = (typeof(jtp))jcc->module_private;
	memset(&param, 0, sizeof(param));
	param.un.var = jtp->node_name;
	param.user_data = 0;
	param.depth = jcc->depth;
	oper = (typeof(oper))jc_var_module_get(&param,
					       global_seq.jvm);
	if (oper->seq_execute) 
		return oper->seq_execute(jcc);

	return JC_OK;
}

int
json_config_type_file_sequence_uninit()
{
	jc_var_module_destroy(global_seq.jvm);
}

int
json_config_type_file_sequence_init()
{
	global_seq.jvm = jc_var_module_create(NULL, NULL, jc_type_file_seq_oper_destroy);
	if (!global_seq.jvm)
		return JC_ERR;

	return JC_OK;
}
